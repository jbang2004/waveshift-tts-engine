# WaveShift TTS Engine - 监控和告警配置
# 用于配置阿里云云监控告警规则

Resources:
  # 函数执行错误率告警
  FunctionErrorRateAlarm:
    Type: 'Aliyun::CMS::MonitorGroup'
    Properties:
      GroupName: 'WaveShift-TTS-Monitoring'
      ContactGroups: 'default-contact-group'

  # 高错误率告警规则
  HighErrorRateAlarmRule:
    Type: 'Aliyun::CMS::Alarm'
    Properties:
      Name: 'WaveShift-TTS-High-Error-Rate'
      MetricName: 'FunctionErrors'
      Namespace: 'acs_fc'
      Period: 300  # 5分钟
      Statistics: 'Sum'
      Threshold: 5  # 5分钟内超过5个错误
      ComparisonOperator: 'GreaterThanThreshold'
      EvaluationCount: 2  # 连续2个周期
      Dimensions:
        - Name: 'serviceName'
          Value: 'waveshift-tts'
        - Name: 'functionName'
          Value: 'tts-processor'
      AlarmActions:
        - 'acs:sms:cn-hangzhou:alert'
        - 'acs:email:cn-hangzhou:alert'

  # 函数执行时长告警
  FunctionDurationAlarm:
    Type: 'Aliyun::CMS::Alarm'
    Properties:
      Name: 'WaveShift-TTS-Long-Duration'
      MetricName: 'FunctionDuration'
      Namespace: 'acs_fc'
      Period: 300
      Statistics: 'Average'
      Threshold: 300000  # 5分钟（毫秒）
      ComparisonOperator: 'GreaterThanThreshold'
      EvaluationCount: 1
      Dimensions:
        - Name: 'serviceName'
          Value: 'waveshift-tts'
        - Name: 'functionName'
          Value: 'tts-processor'

  # GPU内存使用率告警
  GPUMemoryUsageAlarm:
    Type: 'Aliyun::CMS::Alarm'
    Properties:
      Name: 'WaveShift-TTS-High-GPU-Memory'
      MetricName: 'GPUMemoryUsage'
      Namespace: 'acs_fc'
      Period: 300
      Statistics: 'Average'
      Threshold: 90  # 90%
      ComparisonOperator: 'GreaterThanThreshold'
      EvaluationCount: 2
      Dimensions:
        - Name: 'serviceName'
          Value: 'waveshift-tts'
        - Name: 'functionName'
          Value: 'tts-processor'

  # 函数调用次数异常告警
  FunctionInvocationAnomalyAlarm:
    Type: 'Aliyun::CMS::Alarm'
    Properties:
      Name: 'WaveShift-TTS-Invocation-Anomaly'
      MetricName: 'FunctionInvocations'
      Namespace: 'acs_fc'
      Period: 900  # 15分钟
      Statistics: 'Sum'
      Threshold: 100  # 15分钟内超过100次调用
      ComparisonOperator: 'GreaterThanThreshold'
      EvaluationCount: 1
      Dimensions:
        - Name: 'serviceName'
          Value: 'waveshift-tts'
        - Name: 'functionName'
          Value: 'tts-processor'

  # 冷启动频率告警
  ColdStartAlarm:
    Type: 'Aliyun::CMS::Alarm'
    Properties:
      Name: 'WaveShift-TTS-Frequent-Cold-Starts'
      MetricName: 'FunctionColdStarts'
      Namespace: 'acs_fc'
      Period: 600  # 10分钟
      Statistics: 'Sum'
      Threshold: 10  # 10分钟内超过10次冷启动
      ComparisonOperator: 'GreaterThanThreshold'
      EvaluationCount: 1
      Dimensions:
        - Name: 'serviceName'
          Value: 'waveshift-tts'
        - Name: 'functionName'
          Value: 'tts-processor'

  # 自定义仪表板
  TTSDashboard:
    Type: 'Aliyun::CMS::Dashboard'
    Properties:
      DashboardName: 'WaveShift-TTS-Dashboard'
      GridData: |
        {
          "widgets": [
            {
              "type": "chart",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "函数调用统计",
                "legend": {"position": "bottom"},
                "metrics": [
                  ["acs_fc", "FunctionInvocations", "serviceName", "waveshift-tts", "functionName", "tts-processor"],
                  [".", "FunctionErrors", ".", ".", ".", "."],
                  [".", "FunctionDuration", ".", ".", ".", "."]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "cn-hangzhou",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "chart",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "GPU资源使用",
                "metrics": [
                  ["acs_fc", "GPUMemoryUsage", "serviceName", "waveshift-tts", "functionName", "tts-processor"],
                  [".", "GPUUtilization", ".", ".", ".", "."]
                ],
                "period": 300,
                "stat": "Average",
                "region": "cn-hangzhou",
                "yAxis": {"left": {"min": 0, "max": 100}}
              }
            },
            {
              "type": "chart",
              "x": 0,
              "y": 12,
              "width": 6,
              "height": 6,
              "properties": {
                "title": "执行时长分布",
                "metrics": [
                  ["acs_fc", "FunctionDuration", "serviceName", "waveshift-tts", "functionName", "tts-processor"]
                ],
                "period": 300,
                "stat": "Average",
                "region": "cn-hangzhou"
              }
            },
            {
              "type": "chart",
              "x": 6,
              "y": 12,
              "width": 6,
              "height": 6,
              "properties": {
                "title": "冷启动频率",
                "metrics": [
                  ["acs_fc", "FunctionColdStarts", "serviceName", "waveshift-tts", "functionName", "tts-processor"]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "cn-hangzhou"
              }
            }
          ]
        }

# 日志配置
LoggingConfig:
  # 日志服务项目
  LogProject:
    Name: 'waveshift-tts-logs'
    Description: 'WaveShift TTS函数计算日志'
    
  # 日志库配置
  LogStores:
    - Name: 'function-logs'
      TTL: 7  # 保留7天
      ShardCount: 2
      
    - Name: 'access-logs'
      TTL: 3  # 保留3天
      ShardCount: 1
      
    - Name: 'error-logs'
      TTL: 30  # 保留30天
      ShardCount: 1

  # 日志索引配置
  LogIndexes:
    function-logs:
      Keys:
        - Key: 'level'
          Type: 'text'
        - Key: 'message'
          Type: 'text'
        - Key: 'task_id'
          Type: 'text'
        - Key: 'duration'
          Type: 'double'
        - Key: 'gpu_memory'
          Type: 'double'
          
    error-logs:
      Keys:
        - Key: 'error_type'
          Type: 'text'
        - Key: 'error_message'
          Type: 'text'
        - Key: 'stack_trace'
          Type: 'text'

# 告警联系组配置
ContactGroups:
  - Name: 'tts-ops-team'
    Contacts:
      - Type: 'email'
        Target: 'ops@yourcompany.com'
      - Type: 'sms'
        Target: '+86-13800138000'
      - Type: 'webhook'
        Target: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# 告警规则模板
AlarmRuleTemplates:
  # 严重告警
  Critical:
    EvaluationCount: 1
    SilenceTime: 300  # 5分钟静默
    NotifyType: 1  # 电话+短信+邮件
    
  # 警告告警
  Warning:
    EvaluationCount: 2
    SilenceTime: 600  # 10分钟静默
    NotifyType: 0  # 短信+邮件
    
  # 信息告警
  Info:
    EvaluationCount: 3
    SilenceTime: 1800  # 30分钟静默
    NotifyType: 2  # 仅邮件

# 性能基线配置
PerformanceBaselines:
  TTS:
    # 正常执行时长（秒）
    NormalDuration: 60
    MaxDuration: 300
    
    # GPU内存使用率
    NormalGPUMemory: 60  # 60%
    MaxGPUMemory: 85     # 85%
    
    # 错误率阈值
    ErrorRate: 0.05      # 5%
    
  # 冷启动基线
  ColdStart:
    NormalCount: 5      # 正常情况下10分钟内5次
    AlertThreshold: 15  # 告警阈值15次
    
  # 并发基线
  Concurrency:
    NormalCount: 10     # 正常并发数
    MaxCount: 30        # 最大并发数